
name: Generate Chess Data

on:
  workflow_dispatch:
    inputs:
      time_limit:
        description: 'Time limit per job in seconds'
        required: true
        default: '600'  # 10 minutes

jobs:
  generate-data:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        job_id: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]
    
    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake python3 python3-pip
        pip3 install numpy

    - name: Build Engine
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        make -j2

    - name: Engine Sanity Check
      run: |
        # Confirm engine binary exists and can respond to 'uci'
        ENGINE_BIN="build/bin/UnderFlaw"
        if [ ! -f "$ENGINE_BIN" ]; then
            ENGINE_BIN="build/UnderFlaw"
        fi
        
        echo "Testing engine startup..."
        chmod +x "$ENGINE_BIN"
        echo "uci" | "$ENGINE_BIN" | grep "uciok"
        echo "Sanity check passed!"

    - name: Debug and Generate Data
      run: |
        # Debug: Check binary location and permissions
        echo "Listing build directory:"
        ls -R build
        
        # Ensure correct permissions if found
        if [ -f build/bin/UnderFlaw ]; then
            chmod +x build/bin/UnderFlaw
        fi
        if [ -f build/UnderFlaw ]; then
            chmod +x build/UnderFlaw
        fi

        # Run generator
        python3 generate_training_data_sparse.py --time ${{ github.event.inputs.time_limit }}
        mv training_data_sparse.bin data_part_${{ matrix.job_id }}.bin

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: training-data-part-${{ matrix.job_id }}
        path: data_part_${{ matrix.job_id }}.bin
